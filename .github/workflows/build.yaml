name: Build Program

# Constants
env:
  SOLANA_VERIFY_VERSION: "0.4.0" # Version of solana-verify to use

on:
  workflow_dispatch: # Allow manual triggering
    inputs:
      program:
        description: "Program to build"
        required: true
        default: "transaction_example"
      network:
        description: "Target network for deployment (requires DEVNET_SOLANA_DEPLOY_URL or MAINNET_SOLANA_DEPLOY_URL secret)"
        required: false
        default: "devnet"
        type: choice
        options:
          - devnet
          - mainnet
      deploy:
        description: "Deploy program (requires DEVNET_DEPLOYER_KEYPAIR/MAINNET_DEPLOYER_KEYPAIR secrets)"
        required: false
        type: boolean
        default: false
      upload_idl:
        description: "Upload IDL (uses either deploy keypair or squads vault automatically)"
        required: false
        type: boolean
        default: true
      verify:
        description: "Verify build against current repository and commit"
        required: false
        type: boolean
        default: true
      use-squads:
        description: "Use Squads for program deployment (requires DEVNET_MULTISIG, DEVNET_MULTISIG_VAULT, MAINNET_MULTISIG, MAINNET_MULTISIG_VAULT secrets)"
        required: false
        type: boolean
        default: false
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]

# Required secrets for this workflow:
#   - DEVNET_SOLANA_DEPLOY_URL: The RPC URL for devnet deployments
#   - MAINNET_SOLANA_DEPLOY_URL: The RPC URL for mainnet deployments
#   - DEVNET_DEPLOYER_KEYPAIR: The base58 encoded keypair for devnet deployments
#   - MAINNET_DEPLOYER_KEYPAIR: The base58 encoded keypair for mainnet deployments
#   - PROGRAM_ADDRESS_KEYPAIR: The keypair for initial program deployment (if program doesn't exist)

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
      - name: Set deployment variables
        run: |
          # Network specific variables
          IS_MAINNET="${{ github.event.inputs.network == 'mainnet' }}"

          # Set URLs and Keys based on network
          if [ "$IS_MAINNET" = "true" ]; then
            echo "DEPLOY_URL=${{ secrets.MAINNET_SOLANA_DEPLOY_URL }}" >> $GITHUB_ENV
            echo "DEPLOYER_KEYPAIR=${{ secrets.MAINNET_DEPLOYER_KEYPAIR }}" >> $GITHUB_ENV
            echo "MULTISIG=${{ secrets.MAINNET_MULTISIG }}" >> $GITHUB_ENV
            echo "MULTISIG_VAULT=${{ secrets.MAINNET_MULTISIG_VAULT }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_URL=${{ secrets.DEVNET_SOLANA_DEPLOY_URL }}" >> $GITHUB_ENV
            echo "DEPLOYER_KEYPAIR=${{ secrets.DEVNET_DEPLOYER_KEYPAIR }}" >> $GITHUB_ENV
            echo "MULTISIG=${{ secrets.DEVNET_MULTISIG }}" >> $GITHUB_ENV
            echo "MULTISIG_VAULT=${{ secrets.DEVNET_MULTISIG_VAULT }}" >> $GITHUB_ENV
          fi

      - uses: ./.github/actions/extract-versions/
        id: versions

      - uses: ./.github/actions/setup/

      - name: Debug Environment Before Anchor Setup
        run: |
          echo "=== Environment Variables Before Anchor Setup ==="
          env | grep -E "SOLANA|ANCHOR"
          echo "==========================="

      - name: Install Solana
        uses: ./.github/actions/setup-solana

      - name: Install Anchor
        uses: ./.github/actions/setup-anchor
        with:
          anchor-version: ${{ env.ANCHOR_VERSION }}

      - name: Set Program Variables
        run: |
          PROGRAM="${{ github.event.inputs.program || 'transaction-example' }}"
          PROGRAM_NAME=${PROGRAM//-/_}
          echo "Looking for program ${PROGRAM_NAME} in Anchor.toml"
          cat ./Anchor.toml
          echo "Running toml command:"
          ~/.cargo/bin/toml get ./Anchor.toml programs.localnet.${PROGRAM_NAME} || true
          PROGRAM_ID=$(~/.cargo/bin/toml get ./Anchor.toml programs.localnet.${PROGRAM_NAME} | tr -d '"')
          echo "Program: $PROGRAM_ID"
          echo "PROGRAM_NAME=${PROGRAM_NAME}" >> $GITHUB_ENV
          echo "PROGRAM_ID=${PROGRAM_ID}" >> $GITHUB_ENV

      - name: Extract Addresses from Keypairs
        run: |
          # Extract deployer addresses
          if [ "$IS_MAINNET" = "true" ]; then
            echo "${{ secrets.MAINNET_DEPLOYER_KEYPAIR }}" > deployer-keypair.json
            echo "DEPLOYER_ADDRESS=$(solana-keygen pubkey deployer-keypair.json)" >> $GITHUB_ENV
            rm deployer-keypair.json
          else
            echo "${{ secrets.DEVNET_DEPLOYER_KEYPAIR }}" > deployer-keypair.json
            echo "DEPLOYER_ADDRESS=$(solana-keygen pubkey deployer-keypair.json)" >> $GITHUB_ENV
            rm deployer-keypair.json
          fi

          # Extract program address if keypair exists
          if [ ! -z "${{ secrets.PROGRAM_ADDRESS_KEYPAIR }}" ]; then
            echo "${{ secrets.PROGRAM_ADDRESS_KEYPAIR }}" > program-keypair.json
            echo "PROGRAM_ADDRESS=$(solana-keygen pubkey program-keypair.json)" >> $GITHUB_ENV
            rm program-keypair.json
          fi

      - name: Debug Initial Structure
        run: |
          echo "Current directory structure:"
          pwd
          ls -la
          echo "Programs directory:"
          ls -la programs/ || true
          echo "Anchor.toml contents:"
          cat Anchor.toml

      - uses: ./.github/actions/build-anchor/
        with:
          testing: false
          devnet: ${{ github.event.inputs.network == 'devnet' }}
          program: ${{ env.PROGRAM_NAME }}

      - uses: ./.github/actions/build-verified/
        id: build-verified
        with:
          verify-version: ${{ env.SOLANA_VERIFY_VERSION }}
          devnet: ${{ github.event.inputs.network == 'devnet' }}
          program: ${{ env.PROGRAM_NAME }}
          program-id: ${{ env.PROGRAM_ID }}

      - name: Create local artifacts directory
        run: |
          # Create directories
          mkdir -p build-artifacts/so
          mkdir -p build-artifacts/idl

          # Check if source files exist
          echo "Checking source files:"
          ls -la ./target/deploy/
          ls -la ./target/idl/

          # Copy with verbose flag
          cp -v ./target/deploy/${{ env.PROGRAM_NAME }}.so build-artifacts/so/
          cp -v ./target/idl/${{ env.PROGRAM_NAME }}.json build-artifacts/idl/

          # Check copied files
          echo "Checking copied files:"
          ls -la build-artifacts/so/
          ls -la build-artifacts/idl/

          # Set permissions
          chmod -R 777 build-artifacts/

          echo "Artifacts copied to project directory at:"
          echo "SO file: ./build-artifacts/so/${{ env.PROGRAM_NAME }}.so"
          echo "IDL file: ./build-artifacts/idl/${{ env.PROGRAM_NAME }}.json"

      - name: Store so files
        if: ${{ !env.ACT }} # Only run on GitHub Actions, skip for local act runs
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PROGRAM_NAME }}-so
          path: |
            ./target/deploy/${{ env.PROGRAM_NAME }}.so

      - name: Store idl files
        if: ${{ !env.ACT }} # Only run on GitHub Actions, skip for local act runs
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PROGRAM_NAME }}-idl
          path: |
            ./target/idl/${{ env.PROGRAM_NAME }}.json

      - name: Print Artifact Locations
        run: |
          echo "Artifacts stored locally at:"
          echo "SO file: ./artifacts/build/${{ env.PROGRAM_NAME }}-so/target/deploy/${{ env.PROGRAM_NAME }}.so"
          echo "IDL file: ./artifacts/build/${{ env.PROGRAM_NAME }}-idl/target/idl/${{ env.PROGRAM_NAME }}.json"

      - uses: ./.github/actions/write-program-buffer/
        id: program-buffer
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
        with:
          program-id: ${{ env.PROGRAM_ID }}
          program: ${{ env.PROGRAM_NAME }}
          rpc-url: ${{ env.DEPLOY_URL }}
          keypair: ${{ env.DEPLOYER_KEYPAIR }}
          buffer-authority-address: ${{ github.event.inputs.use-squads == 'true' && env.MULTISIG_VAULT || env.DEPLOYER_ADDRESS  }}

      - uses: ./.github/actions/write-idl-buffer/
        id: idl-buffer
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.upload_idl == 'true'
        with:
          program-id: ${{ env.PROGRAM_ID }}
          program: ${{ env.PROGRAM_NAME }}
          rpc-url: ${{ env.DEPLOY_URL }}
          keypair: ${{ env.DEPLOYER_KEYPAIR }}
          idl-authority: ${{ github.event.inputs.use-squads == 'true' && env.MULTISIG_VAULT || env.DEPLOYER_ADDRESS  }}

      - uses: ./.github/actions/program-upgrade/
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' && github.event.inputs.use-squads == 'false'
        with:
          program-id: ${{ env.PROGRAM_ID }}
          program: ${{ env.PROGRAM_NAME }}
          buffer: ${{ steps.program-buffer.outputs.buffer }}
          rpc-url: ${{ env.DEPLOY_URL }}
          keypair: ${{ env.DEPLOYER_KEYPAIR }}
          program-keypair: ${{ secrets.PROGRAM_ADDRESS_KEYPAIR }}

      - uses: ./.github/actions/idl-upload/
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.upload_idl == 'true' && github.event.inputs.use-squads == 'false'
        with:
          program-id: ${{ env.PROGRAM_ID }}
          rpc-url: ${{ env.DEPLOY_URL }}
          keypair: ${{ env.DEPLOYER_KEYPAIR }}
          idl-buffer: ${{ steps.idl-buffer.outputs.buffer }}

      - uses: ./.github/actions/verify-build/
        id: verify-build
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.verify == 'true'
        with:
          verify-version: ${{ env.SOLANA_VERIFY_VERSION }}
          program-id: ${{ env.PROGRAM_ID }}
          program: ${{ env.PROGRAM_NAME }}
          network: ${{ github.event.inputs.network }}
          rpc-url: ${{ env.DEPLOY_URL }}
          keypair: ${{ env.DEPLOYER_KEYPAIR }}
          repo-url: ${{ github.server_url }}/${{ github.repository }}
          commit-hash: ${{ github.sha }}
          use-squads: ${{ github.event.inputs.use-squads }}
          vault-address: ${{ env.MULTISIG_VAULT }}

      - name: Deploy Program (Squads)
        if: github.event.inputs.deploy == 'true' && github.event.inputs.use-squads == 'true'
        run: |
          # Install dependencies
          npm install @sqds/multisig @solana/web3.js @coral-xyz/anchor yargs

          echo "PDA Transaction: ${{ steps.verify-build.outputs.pda_tx }}"

          # Run upgrade script
          npx ts-node scripts/squad-upgrade.ts \
            --rpc ${{ env.DEPLOY_URL }} \
            --program ${{ env.PROGRAM_ID }} \
            --buffer ${{ steps.program-buffer.outputs.buffer }} \
            --idl-buffer ${{ steps.idl-buffer.outputs.buffer }} \
            --multisig ${{ env.MULTISIG }} \
            --keypair <(echo '${{ env.DEPLOYER_KEYPAIR }}') \
            --name "Deploy ${{ env.PROGRAM_NAME }}" \
            --pda-tx '${{ steps.verify-build.outputs.pda_tx }}'
