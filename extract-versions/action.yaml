name: "Extract Versions"
description: "Extracts Solana and Anchor versions from anchor.toml or Cargo.lock"
outputs:
  solana_version:
    description: "Detected Solana version"
    value: ${{ steps.extract.outputs.solana_version }}
  anchor_version:
    description: "Detected Anchor version"
    value: ${{ steps.extract.outputs.anchor_version }}

runs:
  using: "composite"
  steps:
    - id: extract
      shell: bash
      run: |
        # Function to extract version from anchor.toml
        extract_from_anchor_toml() {
          local key=$1
          if [ -f "anchor.toml" ]; then
            grep "^${key}_version *= *\".*\"" anchor.toml | cut -d'"' -f2
          fi
        }

        # Extract Solana version
        if [ -n "${{ github.event.inputs.solana_version }}" ]; then
          SOLANA_VERSION="${{ github.event.inputs.solana_version }}"
          echo "Using override Solana version: ${SOLANA_VERSION}"
        else
          # First try anchor.toml
          SOLANA_VERSION=$(extract_from_anchor_toml "solana")
          if [ -n "${SOLANA_VERSION}" ]; then
            echo "Detected Solana version from anchor.toml: ${SOLANA_VERSION}"
          else
            # Fallback to Cargo.lock
            SOLANA_VERSION=$(grep -A 2 'name = "solana-program"' Cargo.lock | grep 'version' | head -n 1 | cut -d'"' -f2)
            echo "Detected Solana version from Cargo.lock: ${SOLANA_VERSION}"
          fi
        fi
        echo "solana_version=${SOLANA_VERSION}" >> $GITHUB_OUTPUT
        echo "SOLANA_VERSION=${SOLANA_VERSION}" >> $GITHUB_ENV

        # Extract Anchor version
        if [ -n "${{ github.event.inputs.anchor_version }}" ]; then
          ANCHOR_VERSION="${{ github.event.inputs.anchor_version }}"
          echo "Using override Anchor version: ${ANCHOR_VERSION}"
        else
          # First try anchor.toml
          ANCHOR_VERSION=$(extract_from_anchor_toml "anchor")
          if [ -n "${ANCHOR_VERSION}" ]; then
            echo "Detected Anchor version from anchor.toml: ${ANCHOR_VERSION}"
          else
            # Fallback to Cargo.lock
            if grep -q 'name = "anchor-lang"' Cargo.lock; then
              ANCHOR_VERSION=$(grep -A 2 'name = "anchor-lang"' Cargo.lock | grep 'version' | head -n 1 | cut -d'"' -f2)
              echo "Detected Anchor version from Cargo.lock: ${ANCHOR_VERSION}"
            else
              echo "No Anchor version found in anchor.toml or Cargo.lock"
            fi
          fi
        fi

        if [ -n "${ANCHOR_VERSION}" ]; then
          echo "anchor_version=${ANCHOR_VERSION}" >> $GITHUB_OUTPUT
          echo "ANCHOR_VERSION=${ANCHOR_VERSION}" >> $GITHUB_ENV
        fi

        # Debug environment variables
        echo "=== Environment Variables Debug ==="
        echo "Content of GITHUB_ENV file:"
        cat $GITHUB_ENV
        echo "=== Direct Environment Variables ==="
        echo "SOLANA_VERSION: $SOLANA_VERSION"
        echo "ANCHOR_VERSION: ${ANCHOR_VERSION:-not found}"
        echo "==========================="
